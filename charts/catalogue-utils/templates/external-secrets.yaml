{{- if (index .Values "external-secrets" "enabled") -}}
  {{- $externalSecrets := index $.Values "external-secrets" }}
  {{- $secretStoreRef := $externalSecrets.secretStoreRef }}
  {{- $defaultName := printf "k8s-%s" $.Release.Namespace }}
  {{- $defaultKind := "ClusterSecretStore" }}
  {{- $storeName := default $defaultName $secretStoreRef.name }}
  {{- $storeKind := default $defaultKind $secretStoreRef.kind }}

  {{- range $api, $services := $externalSecrets.schema }}
    {{- if and (hasKey $.Values.catalogue $api) (index $.Values.catalogue $api) }}
      {{- range $service := $services }}
        {{- if has $service (list "elasticsearch" "mongodb" "rabbitmq" "google_service_account" "gcs_bucket") }}
          {{- $executeCode := true }}
          {{- if and (eq $service "google_service_account") (not (index $.Values "crossplane-buckets" "enabled")) }}
            {{- $executeCode = false }}
          {{- end }}
          {{- if $executeCode }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: catalogue-{{ $api }}-{{ $service }}
spec:
  refreshInterval: "1m"
  secretStoreRef:
    name: {{ $storeName }}
    kind: {{ $storeKind }}
  target:
    creationPolicy: Owner
    template:
      data:
        {{- if eq $service "elasticsearch" }}
        ELASTICSEARCH_URI: "{{ `{{ .eck_uri }}` }}"
        {{- end }}
        {{- if eq $service "mongodb" }}
        MONGODB_URI: mongodb://{{ `{{ .mongodb_username }}` }}:{{ `{{ .mongodb_password }}` }}@{{ default $.Values.mongodb.fullnameOverride $.Values.mongodb.name "catalogue-mongodb" }}-svc/{{ `{{ .mongodb_username }}` }}?readPreference=primary&replicaSet={{ default $.Values.mongodb.fullnameOverride $.Values.mongodb.name "catalogue-mongodb" }}
        {{- end }}
        {{- if eq $service "rabbitmq" }}
        RABBITMQ_URI: amqp://{{ `{{ .rabbitmq_username }}` }}:{{ `{{ .rabbitmq_password }}` }}@{{ default $.Values.rabbitmq.fullnameOverride $.Values.rabbitmq.name "catalogue-rabbitmq" }}/catalogue
        {{- end }}
        {{- if eq $service "gcs_bucket" }}
        GCS_BUCKET_NAME: "{{ `{{ .gcs_bucket_name }}` }}"
        {{- end }}
        {{- if and (eq $service "google_service_account") (index $.Values "crossplane-buckets" "enabled") }}
        GOOGLE_SERVICE_ACCOUNT_JSON: "{{ `{{ .google_service_account }}` }}"
        {{- end }}
  data:
    {{- if eq $service "mongodb" }}
    - secretKey: mongodb_username
      remoteRef:
        key: {{ default (printf "catalogue-mongodb-catalogue-%s-catalogue-%s" $api $api) (get $.Values (printf "external-secrets.secrets.catalogue-%s.mongodb_username.key" $api)) }}
        property: {{ default "username" (get $.Values (printf "external-secrets.secrets.catalogue-%s.mongodb_username.property" $api)) }}
    - secretKey: mongodb_password
      remoteRef:
        key: {{ default (printf "catalogue-mongodb-catalogue-%s-catalogue-%s" $api $api) (get $.Values (printf "external-secrets.secrets.catalogue-%s.mongodb_password.key" $api)) }}
        property: {{ default "password" (get $.Values (printf "external-secrets.secrets.catalogue-%s.mongodb_password.property" $api)) }}
    {{- end }}
    {{- if eq $service "rabbitmq" }}
    - secretKey: rabbitmq_username
      remoteRef:
        key: {{ default (printf "catalogue-rabbitmq-user-%s-user-credentials" $api) (get $.Values (printf "external-secrets.secrets.catalogue-%s.rabbitmq_username.key" $api)) }}
        property: {{ default "username" (get $.Values (printf "external-secrets.secrets.catalogue-%s.rabbitmq_username.property" $api)) }}
    - secretKey: rabbitmq_password
      remoteRef:
        key: {{ default (printf "catalogue-rabbitmq-user-%s-user-credentials" $api) (get $.Values (printf "external-secrets.secrets.catalogue-%s.rabbitmq_password.key" $api)) }}
        property: {{ default "password" (get $.Values (printf "external-secrets.secrets.catalogue-%s.rabbitmq_password.property" $api)) }}
    {{- end }}
    {{- if and (eq $service "google_service_account") (index $.Values "crossplane-buckets" "enabled") }}
    - secretKey: google_service_account
      remoteRef:
        key: {{ default (index $.Values "crossplane-buckets" "shareServiceAccount" "name") (get $.Values (printf "external-secrets.secrets.catalogue-%s.google_service_account.key" $api)) }}
        property: {{ default "privateKey" (get $.Values (printf "external-secrets.secrets.catalogue-%s.google_service_account.property" $api)) }}
    {{- end }}
    {{- if eq $service "gcs_bucket" }}
    - secretKey: gcs_bucket_name
      remoteRef:
        key: {{ default "catalogue-media-api-bucket" (get $.Values (printf "external-secrets.secrets.catalogue-%s.gcs_bucket_name.key" $api)) }}
        property: {{ default "GCS_BUCKET_NAME" (get $.Values (printf "external-secrets.secrets.catalogue-%s.gcs_bucket_name.property" $api)) }}
    {{- end }}
    {{- if eq $service "elasticsearch" }}
    - secretKey: eck_uri
      remoteRef:
        key: {{ default "catalogue-eck-uri" (get $.Values (printf "external-secrets.secrets.catalogue-%s.elasticsearch.key" $api)) }}
        property: {{ default "ELASTICSEARCH_URI" (get $.Values (printf "external-secrets.secrets.catalogue-%s.elasticsearch.property" $api)) }}
    {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}
